<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" note="width=device-width, initial-scale=1"/>
  <title>Business Monthly Report</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --paper:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --soft:#f1f5f9;

      --blue:#2563eb;
      --teal:#0ea5e9;
      --violet:#7c3aed;
      --amber:#f59e0b;

      --good:#16a34a;
      --bad:#dc2626;

      --shadow: 0 30px 60px -25px rgba(0,0,0,0.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Noto Sans JP',system-ui,sans-serif;
      background: radial-gradient(1200px 700px at 10% 10%, #18223d, var(--bg));
      color:var(--ink);
      padding:18px;
      display:flex;
      justify-content:center;
      overflow-x:auto;
    }
    a{ color: inherit; text-decoration: none; }

    .app{
      width:min(1360px, 100%);
      background:var(--paper);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.10);
    }

    /* Topbar */
    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      background:linear-gradient(90deg, #0f172a, #101c38);
      color:#fff;
      border-bottom:1px solid rgba(255,255,255,0.08);
      flex-wrap:wrap;
    }
    .brand{
      display:flex; flex-direction:column; gap:3px;
      min-width: 260px;
    }
    .brand h1{
      margin:0;
      font-family:'Montserrat',sans-serif;
      letter-spacing:1px;
      font-size:16px;
      font-weight:800;
      white-space:nowrap;
    }
    .brand .sub{ font-size:12px; opacity:.85; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .nav{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .tab{
      padding:9px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(255,255,255,0.08);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .tab.active{ background:rgba(37,99,235,0.92); border-color:rgba(37,99,235,1); }
    .controls{
      display:flex; gap:10px; align-items:center; justify-content:flex-end;
      flex:1 1 auto;
      flex-wrap:wrap;
      min-width: 300px;
    }
    .chip{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(255,255,255,0.08);
      white-space:nowrap;
    }
    .chip .p{ font-family:'Montserrat',sans-serif; font-weight:900; color:#93c5fd; font-size:13px; }
    .chip .s{ font-size:12px; opacity:.9; }
    .range{
      display:flex; gap:8px; align-items:center;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(255,255,255,0.08);
    }
    .range label{ font-size:12px; font-weight:900; opacity:.9; white-space:nowrap; }
    .range input{
      border:none; outline:none;
      padding:6px 8px;
      border-radius:10px;
      background:rgba(255,255,255,0.12);
      color:#fff;
      font-weight:900;
      font-size:12px;
    }
    .range input::-webkit-calendar-picker-indicator{ filter: invert(1); opacity:.9; }

    .btn{
      appearance:none; border:none; cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      font-weight:900; font-size:12px;
      color:#fff;
      background:rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.16);
      transition:.15s transform, .15s background;
      white-space:nowrap;
    }
    .btn:hover{ background:rgba(255,255,255,0.16); transform:translateY(-1px); }
    .btn.primary{ background:rgba(37,99,235,0.92); border-color:rgba(37,99,235,1); }
    .btn.primary:hover{ background:rgba(37,99,235,1); }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: minmax(0, 1fr) clamp(360px, 34vw, 520px);
      gap:14px;
      padding:14px;
      background:linear-gradient(180deg, #ffffff, #f8fafc);
    }
    @media (max-width: 1180px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: 0 14px 30px -24px rgba(15,23,42,0.35);
      min-width:0;
    }

    .hrow{ display:flex; align-items:center; gap:10px; margin-bottom:10px; }
    .h2{
      margin:0;
      font-size:14px;
      font-weight:900;
      display:flex; align-items:center; gap:10px;
    }
    .dot{ width:10px; height:10px; border-radius:4px; display:inline-block; }
    .dot.blue{ background:var(--blue); }
    .dot.teal{ background:var(--teal); }
    .dot.violet{ background:var(--violet); }
    .dot.amber{ background:var(--amber); }

    /* KPI cards */
    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 720px){ .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); } }

    .kpi{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:linear-gradient(180deg, #ffffff, #f8fafc);
      min-width:0;
    }
    .kpi .label{ font-size:11px; font-weight:900; color:var(--muted); }
    .kpi .val{ display:flex; align-items:baseline; gap:6px; margin-top:6px; }
    .kpi .num{ font-family:'Montserrat',sans-serif; font-weight:900; font-size:28px; }
    .kpi .unit{ font-size:12px; font-weight:900; color:#94a3b8; }
    .delta{
      margin-top:8px;
      font-size:11px;
      font-weight:900;
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
    }
    .delta .tag{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--soft);
      font-weight:900;
    }
    .delta.good{ color:var(--good); }
    .delta.bad{ color:var(--bad); }
    .delta.neutral{ color:var(--muted); }

    /* Highlights (editable) */
    .highlights{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 720px){ .highlights{ grid-template-columns:1fr; } }
    .highlight{
      border-radius:14px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, #ffffff, #f8fafc);
      padding:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .highlight .left{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .highlight .t{ font-size:11px; font-weight:900; color:var(--muted); }
    .highlight input{
      width:140px;
      border:none; outline:none;
      padding:10px 12px;
      border-radius:12px;
      background:var(--soft);
      font-family:'Montserrat',sans-serif;
      font-weight:900;
      font-size:22px;
      text-align:right;
    }
    .highlight input:focus{ box-shadow: inset 0 0 0 2px rgba(37,99,235,.55); }
    .badge{
      font-size:11px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--soft);
      white-space:nowrap;
      color:var(--muted);
    }

    /* Metric inputs */
    .metric-wrap{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 900px){ .metric-wrap{ grid-template-columns:1fr; } }
    .metric-box{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
      min-width:0;
    }
    .metric-title{
      margin:0 0 10px 0;
      font-size:13px;
      font-weight:900;
    }
    .metric-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    .metric{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:linear-gradient(180deg, #ffffff, #f8fafc);
      min-width:0;
    }
    .metric .mlabel{
      font-size:11px;
      font-weight:900;
      color:var(--muted);
      margin-bottom:6px;
    }
    .metric .mrow{ display:flex; gap:8px; align-items:baseline; }
    .metric input{
      width:100%;
      border:none; outline:none;
      padding:10px 12px;
      border-radius:12px;
      background:var(--soft);
      font-family:'Montserrat',sans-serif;
      font-weight:900;
      font-size:18px;
      text-align:right;
      min-width:0;
    }
    .metric input:focus{ box-shadow: inset 0 0 0 2px rgba(37,99,235,.55); }
    .metric .unit{ font-size:11px; font-weight:900; color:#94a3b8; white-space:nowrap; }
    .metric.full{ grid-column:1 / -1; }

    /* Charts */
    .chart-wrap{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
      overflow:hidden;
    }
    canvas{ max-width:100%; }

    /* Topics */
    #topics{
      width:100%;
      min-height:220px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      outline:none;
      resize:vertical;
      font-size:13px;
      line-height:1.8;
      background:linear-gradient(180deg, #fff, #fffef2);
    }
    #topics:focus{ box-shadow: inset 0 0 0 2px rgba(37,99,235,.55); }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <h1>BUSINESS MONTHLY REPORT</h1>
        <div class="sub">月報（Page1）／法人活動（Page2）／PDF印刷（2ページ）／共有HTML出力</div>
      </div>

      <div class="nav">
        <a class="tab active" href="./index.html">月報</a>
        <a class="tab" href="./partners.html">法人活動</a>
        <a class="tab" href="./print.html" target="_blank" rel="noopener">PDF印刷</a>
      </div>

      <div class="controls">
        <div class="chip">
          <div class="p" id="periodLabel">—</div>
          <div class="s" id="saveStatus">未保存</div>
        </div>

        <div class="range" title="当月集計期間">
          <label>当月期間</label>
          <input type="date" id="periodStart">
          <span style="opacity:.8;">–</span>
          <input type="date" id="periodEnd">
        </div>

        <button class="btn" id="btnShare">共有用HTML出力</button>
        <button class="btn primary" id="btnPrint">PDF印刷（2ページ）</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div style="display:flex;flex-direction:column;gap:14px;min-width:0;">
        <div class="card">
          <div class="hrow">
            <h2 class="h2"><span class="dot blue"></span>主要KPI</h2>
          </div>

          <div class="kpis">
            <div class="kpi">
              <div class="label">総歩留り（契約 / 来場）</div>
              <div class="val"><span class="num" id="k_ty">0.0</span><span class="unit">%</span></div>
              <div class="delta neutral" id="d_ty"></div>
            </div>
            <div class="kpi">
              <div class="label">法人来場比（法人来場 / 来場）</div>
              <div class="val"><span class="num" id="k_cvr">0.0</span><span class="unit">%</span></div>
              <div class="delta neutral" id="d_cvr"></div>
            </div>
            <div class="kpi">
              <div class="label">法人契約比（法人契約 / 総契約）</div>
              <div class="val"><span class="num" id="k_ccr">0.0</span><span class="unit">%</span></div>
              <div class="delta neutral" id="d_ccr"></div>
            </div>
            <div class="kpi">
              <div class="label">法人歩留り（法人契約 / 法人来場）</div>
              <div class="val"><span class="num" id="k_cy">0.0</span><span class="unit">%</span></div>
              <div class="delta neutral" id="d_cy"></div>
            </div>
          </div>

          <div class="highlights">
            <div class="highlight" style="border-left:6px solid var(--amber);">
              <div class="left">
                <div class="t">提携会社数</div>
                <input type="number" id="companyCount" min="0" step="1">
              </div>
              <div class="badge" id="asOfLabel">—</div>
            </div>

            <div class="highlight" style="border-left:6px solid var(--violet);">
              <div class="left">
                <div class="t">対象企業総数</div>
                <input type="number" id="targetCount" min="0" step="1">
              </div>
              <div class="badge">TARGETS</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hrow">
            <h2 class="h2"><span class="dot teal"></span>実績・比較・次月計画</h2>
          </div>

          <div class="metric-wrap">
            <div class="metric-box">
              <p class="metric-title">当月実績</p>
              <div class="metric-grid">
                <div class="metric">
                  <div class="mlabel">総来場</div>
                  <div class="mrow"><input type="number" id="v_totalVisit" min="0" step="1"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">総契約</div>
                  <div class="mrow"><input type="number" id="v_totalContract" min="0" step="1"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">法人来場</div>
                  <div class="mrow"><input type="number" id="v_corpVisit" min="0" step="1"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">法人契約</div>
                  <div class="mrow"><input type="number" id="v_corpContract" min="0" step="1"><span class="unit">件</span></div>
                </div>
                <div class="metric full">
                  <div class="mlabel">紹介カード</div>
                  <div class="mrow"><input type="number" id="v_referralCards" min="0" step="1"><span class="unit">枚</span></div>
                </div>
              </div>
            </div>

            <div class="metric-box">
              <p class="metric-title">当月過去実績（前年同月）</p>
              <div class="metric-grid">
                <div class="metric">
                  <div class="mlabel">総来場</div>
                  <div class="mrow"><input type="number" id="ly_totalVisit" min="0" step="1"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">総契約</div>
                  <div class="mrow"><input type="number" id="ly_totalContract" min="0" step="1"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">法人来場</div>
                  <div class="mrow"><input type="number" id="ly_corpVisit" min="0" step="1"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">法人契約</div>
                  <div class="mrow"><input type="number" id="ly_corpContract" min="0" step="1"><span class="unit">件</span></div>
                </div>
                <div class="metric full">
                  <div class="mlabel">紹介カード</div>
                  <div class="mrow"><input type="number" id="ly_referralCards" min="0" step="1"><span class="unit">枚</span></div>
                </div>
              </div>
            </div>

            <div class="metric-box">
              <p class="metric-title">次月過去実績（前年次月）</p>
              <div class="metric-grid">
                <div class="metric">
                  <div class="mlabel">総来場</div>
                  <div class="mrow"><input type="number" id="nm_totalVisit" min="0" step="1"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">総契約</div>
                  <div class="mrow"><input type="number" id="nm_totalContract" min="0" step="1"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">法人来場</div>
                  <div class="mrow"><input type="number" id="nm_corpVisit" min="0" step="1"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">法人契約</div>
                  <div class="mrow"><input type="number" id="nm_corpContract" min="0" step="1"><span class="unit">件</span></div>
                </div>
                <div class="metric full">
                  <div class="mlabel">紹介カード</div>
                  <div class="mrow"><input type="number" id="nm_referralCards" min="0" step="1"><span class="unit">枚</span></div>
                </div>
              </div>
            </div>

            <div class="metric-box">
              <p class="metric-title">次月目標</p>
              <div class="metric-grid">
                <div class="metric">
                  <div class="mlabel">総来場（目標）</div>
                  <div class="mrow"><input type="number" id="tg_totalVisit" min="0" step="1"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">総契約（目標）</div>
                  <div class="mrow"><input type="number" id="tg_totalContract" min="0" step="1"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">法人来場（目標）</div>
                  <div class="mrow"><input type="number" id="tg_corpVisit" min="0" step="1"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">法人契約（目標）</div>
                  <div class="mrow"><input type="number" id="tg_corpContract" min="0" step="1"><span class="unit">件</span></div>
                </div>
                <div class="metric full">
                  <div class="mlabel">紹介カード（目標）</div>
                  <div class="mrow"><input type="number" id="tg_referralCards" min="0" step="1"><span class="unit">枚</span></div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="card">
          <div class="hrow">
            <h2 class="h2"><span class="dot violet"></span>Topics</h2>
          </div>
          <textarea id="topics" placeholder="・今月の特筆事項
・新規提携企業の反応
・次月へのアクション"></textarea>
        </div>
      </div>

      <!-- RIGHT -->
      <div style="display:flex;flex-direction:column;gap:14px;min-width:0;">
        <div class="card">
          <div class="hrow">
            <h2 class="h2"><span class="dot blue"></span>KPI（%）当月 vs 前年同月</h2>
          </div>
          <div class="chart-wrap"><canvas id="chartKPI" height="210"></canvas></div>
        </div>

        <div class="card">
          <div class="hrow">
            <h2 class="h2"><span class="dot teal"></span>ファネル（歩留り）</h2>
          </div>
          <div class="chart-wrap"><canvas id="chartFunnel" height="220"></canvas></div>
        </div>

        <div class="card">
          <div class="hrow">
            <h2 class="h2"><span class="dot teal"></span>法人比率（来場）</h2>
          </div>
          <div class="chart-wrap"><canvas id="chartShare" height="240"></canvas></div>
        </div>

        <div class="card">
          <div class="hrow">
            <h2 class="h2"><span class="dot amber"></span>提携先 上位（来場 / 初回 / 申込 / 契約）</h2>
          </div>
          <div class="chart-wrap"><canvas id="chartPartners" height="260"></canvas></div>
        </div>
      </div>
    </div>
  </div>

<script>
/** ======================
 *  Shared State / Storage
 *  ====================== */
const STORAGE_KEY = "hb_monthly_report_state_v2";

const DEFAULT_STATE = (() => {
  const pad2 = (n)=>String(n).padStart(2,"0");
  const monthStartEnd = (y,m)=>{
    const s = new Date(y, m-1, 1);
    const e = new Date(y, m, 0);
    const iso = (d)=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    return { start: iso(s), end: iso(e) };
  };
  const cur = monthStartEnd(2025,12);

  return {
    meta: { periodStart: cur.start, periodEnd: cur.end },
    counts: { partnerCompanies: 9, targetCompanies: 1856 },
    perf: { totalVisit: 85, totalContract: 4, corpVisit: 5, corpContract: 1, referralCards: 3 },
    lastYear: { totalVisit: 148, totalContract: 26, corpVisit: 9, corpContract: 2, referralCards: 0 },
    nextMonthPast: { totalVisit: 0, totalContract: 0, corpVisit: 0, corpContract: 0, referralCards: 0 },
    nextTarget: { totalVisit: 0, totalContract: 0, corpVisit: 0, corpContract: 0, referralCards: 0 },
    partners: [
      { name:"", property:"", visit:0, first:0, apply:0, contract:0, pr:"", cost:0, benefit:"", fee:0, note:"" }
    ],
    planned: [
      { name:"", companySize:"", proposal:"", status:"", nextAction:"", schedule:"" }
    ],
    topics: ""
  };
})();

function deepMerge(base, patch){
  const out = structuredClone(base);
  for(const k of Object.keys(patch||{})){
    if(patch[k] && typeof patch[k]==="object" && !Array.isArray(patch[k])){
      out[k] = deepMerge(out[k]||{}, patch[k]);
    }else{
      out[k] = patch[k];
    }
  }
  return out;
}

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return structuredClone(DEFAULT_STATE);
  try{
    const obj = JSON.parse(raw);
    const merged = deepMerge(DEFAULT_STATE, obj);
    // arrays
    merged.partners = Array.isArray(obj.partners) && obj.partners.length ? obj.partners : structuredClone(DEFAULT_STATE.partners);
    merged.planned  = Array.isArray(obj.planned) && obj.planned.length ? obj.planned : structuredClone(DEFAULT_STATE.planned);
    return merged;
  }catch{
    return structuredClone(DEFAULT_STATE);
  }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  setSaveStatus("保存済み");
}
function setSaveStatus(s){ document.getElementById("saveStatus").textContent = s; }

let state = loadState();

/** ======================
 * Helpers
 * ====================== */
const $ = (id)=>document.getElementById(id);
const clamp0 = (v)=> {
  const n = Number(v);
  return Number.isFinite(n) && n > 0 ? n : 0;
};
const pct = (a,b)=> (b>0) ? (a/b)*100 : 0;
const fmt1 = (n)=> (Number.isFinite(n)?n:0).toFixed(1);
const pad2 = (n)=>String(n).padStart(2,"0");

function fmtJPDate(iso){
  if(!iso) return "—";
  const [y,m,d] = iso.split("-").map(Number);
  if(!y||!m||!d) return "—";
  return `${y}年${pad2(m)}月${pad2(d)}日現在`;
}
function derivePeriodLabel(isoStart){
  if(!isoStart) return "—";
  const [y,m] = isoStart.split("-").map(Number);
  if(!y||!m) return "—";
  return `${y}.${pad2(m)}`;
}

function setDelta(elId, now, base){
  const el = $(elId);
  const diff = now - base;
  const sign = diff > 0 ? "+" : "";
  const cls = (Math.abs(diff) < 0.05) ? "neutral" : (diff > 0 ? "good" : "bad");
  el.className = "delta " + cls;
  el.innerHTML = "";
  const tag = document.createElement("span");
  tag.className = "tag";
  tag.textContent = `前年差 ${sign}${fmt1(diff)}pt`;
  const small = document.createElement("span");
  small.textContent = `（前年 ${fmt1(base)}%）`;
  el.appendChild(tag);
  el.appendChild(small);
}

/** ======================
 * Charts
 * ====================== */
const centerLabelPlugin = {
  id: "centerLabel",
  afterDraw(chart){
    if(chart.config.type !== "doughnut") return;
    const {ctx, chartArea} = chart;
    if(!chartArea) return;

    const data = chart.data.datasets?.[0]?.data || [];
    const corp = Number(data[0] || 0);
    const total = data.reduce((a,b)=>a+Number(b||0), 0);
    const p = total ? (corp/total*100) : 0;

    const cx = (chartArea.left + chartArea.right) / 2;
    const cy = (chartArea.top + chartArea.bottom) / 2;

    ctx.save();
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "#0f172a";
    ctx.font = "800 30px Montserrat, sans-serif";
    ctx.fillText(p.toFixed(1) + "%", cx, cy - 6);
    ctx.fillStyle = "#64748b";
    ctx.font = "700 12px Noto Sans JP, sans-serif";
    ctx.fillText("法人比率（来場）", cx, cy + 18);
    ctx.restore();
  }
};
Chart.register(centerLabelPlugin);

let chartKPI, chartFunnel, chartShare, chartPartners;

function initCharts(){
  chartKPI = new Chart($("chartKPI"), {
    type:"bar",
    data:{
      labels:["総歩留り","法人来場比","法人契約比","法人歩留り"],
      datasets:[
        { label:"当月", data:[0,0,0,0], backgroundColor:"rgba(37,99,235,0.35)", borderColor:"rgba(37,99,235,1)", borderWidth:1 },
        { label:"前年同月", data:[0,0,0,0], backgroundColor:"rgba(244,63,94,0.25)", borderColor:"rgba(244,63,94,1)", borderWidth:1 }
      ]
    },
    options:{
      responsive:true,
      plugins:{ legend:{ position:"top" } },
      scales:{
        y:{ beginAtZero:true, suggestedMax:30, ticks:{ callback:(v)=>v+"%" } }
      }
    }
  });

  chartFunnel = new Chart($("chartFunnel"), {
    type:"bar",
    data:{
      labels:["来場 → 契約","法人来場 → 法人契約"],
      datasets:[{ label:"歩留り(%)", data:[0,0], backgroundColor:"rgba(14,165,233,0.35)", borderColor:"rgba(14,165,233,1)", borderWidth:1 }]
    },
    options:{
      indexAxis:"y",
      responsive:true,
      plugins:{ legend:{ display:false } },
      scales:{
        x:{ beginAtZero:true, suggestedMax:30, ticks:{ callback:(v)=>v+"%" } }
      }
    }
  });

  chartShare = new Chart($("chartShare"), {
    type:"doughnut",
    data:{
      labels:["法人","非法人"],
      datasets:[{
        data:[0,0],
        backgroundColor:["rgba(37,99,235,0.55)","rgba(244,63,94,0.35)"],
        borderColor:["rgba(37,99,235,1)","rgba(244,63,94,1)"],
        borderWidth:1,
        cutout:"62%"
      }]
    },
    options:{
      responsive:true,
      plugins:{ legend:{ position:"bottom" } }
    }
  });

  chartPartners = new Chart($("chartPartners"), {
    type:"bar",
    data:{
      labels:[],
      datasets:[
        { label:"来場", data:[], backgroundColor:"rgba(37,99,235,0.35)", borderColor:"rgba(37,99,235,1)", borderWidth:1 },
        { label:"初回", data:[], backgroundColor:"rgba(14,165,233,0.35)", borderColor:"rgba(14,165,233,1)", borderWidth:1 },
        { label:"申込", data:[], backgroundColor:"rgba(245,158,11,0.35)", borderColor:"rgba(245,158,11,1)", borderWidth:1 },
        { label:"契約", data:[], backgroundColor:"rgba(124,58,237,0.35)", borderColor:"rgba(124,58,237,1)", borderWidth:1 },
      ]
    },
    options:{
      indexAxis:"y",
      responsive:true,
      plugins:{ legend:{ position:"top" } },
      scales:{ x:{ beginAtZero:true, ticks:{ precision:0 } } }
    }
  });
}

function updateCharts(){
  const c = state.perf;
  const ly = state.lastYear;

  const k_ty  = pct(c.totalContract, c.totalVisit);
  const k_cvr = pct(c.corpVisit, c.totalVisit);
  const k_ccr = pct(c.corpContract, c.totalContract);
  const k_cy  = pct(c.corpContract, c.corpVisit);

  const ly_ty  = pct(ly.totalContract, ly.totalVisit);
  const ly_cvr = pct(ly.corpVisit, ly.totalVisit);
  const ly_ccr = pct(ly.corpContract, ly.totalContract);
  const ly_cy  = pct(ly.corpContract, ly.corpVisit);

  chartKPI.data.datasets[0].data = [Number(fmt1(k_ty)), Number(fmt1(k_cvr)), Number(fmt1(k_ccr)), Number(fmt1(k_cy))];
  chartKPI.data.datasets[1].data = [Number(fmt1(ly_ty)), Number(fmt1(ly_cvr)), Number(fmt1(ly_ccr)), Number(fmt1(ly_cy))];
  chartKPI.update();

  chartFunnel.data.datasets[0].data = [Number(fmt1(k_ty)), Number(fmt1(k_cy))];
  chartFunnel.update();

  const nonCorp = Math.max(0, c.totalVisit - c.corpVisit);
  chartShare.data.datasets[0].data = [c.corpVisit, nonCorp];
  chartShare.update();

  const rows = (state.partners||[])
    .map(p=>({
      name: (p.name || "（未入力）").trim(),
      visit: clamp0(p.visit),
      first: clamp0(p.first),
      apply: clamp0(p.apply),
      contract: clamp0(p.contract)
    }))
    .filter(x => x.visit>0 || x.first>0 || x.apply>0 || x.contract>0);

  rows.sort((a,b)=> (b.visit+b.first+b.apply+b.contract) - (a.visit+a.first+a.apply+a.contract));
  const top = rows.slice(0, 8);

  chartPartners.data.labels = top.map(x=>x.name);
  chartPartners.data.datasets[0].data = top.map(x=>x.visit);
  chartPartners.data.datasets[1].data = top.map(x=>x.first);
  chartPartners.data.datasets[2].data = top.map(x=>x.apply);
  chartPartners.data.datasets[3].data = top.map(x=>x.contract);
  chartPartners.update();
}

/** ======================
 * Bind UI
 * ====================== */
function bind(){
  // dates
  $("periodStart").value = state.meta.periodStart;
  $("periodEnd").value = state.meta.periodEnd;

  $("periodLabel").textContent = derivePeriodLabel(state.meta.periodStart);
  $("asOfLabel").textContent = fmtJPDate(state.meta.periodEnd);

  // counts
  $("companyCount").value = clamp0(state.counts.partnerCompanies);
  $("targetCount").value = clamp0(state.counts.targetCompanies);

  // perf
  const c = state.perf;
  $("v_totalVisit").value = clamp0(c.totalVisit);
  $("v_totalContract").value = clamp0(c.totalContract);
  $("v_corpVisit").value = clamp0(c.corpVisit);
  $("v_corpContract").value = clamp0(c.corpContract);
  $("v_referralCards").value = clamp0(c.referralCards);

  // last year
  const ly = state.lastYear;
  $("ly_totalVisit").value = clamp0(ly.totalVisit);
  $("ly_totalContract").value = clamp0(ly.totalContract);
  $("ly_corpVisit").value = clamp0(ly.corpVisit);
  $("ly_corpContract").value = clamp0(ly.corpContract);
  $("ly_referralCards").value = clamp0(ly.referralCards);

  // next month past
  const nm = state.nextMonthPast;
  $("nm_totalVisit").value = clamp0(nm.totalVisit);
  $("nm_totalContract").value = clamp0(nm.totalContract);
  $("nm_corpVisit").value = clamp0(nm.corpVisit);
  $("nm_corpContract").value = clamp0(nm.corpContract);
  $("nm_referralCards").value = clamp0(nm.referralCards);

  // target
  const tg = state.nextTarget;
  $("tg_totalVisit").value = clamp0(tg.totalVisit);
  $("tg_totalContract").value = clamp0(tg.totalContract);
  $("tg_corpVisit").value = clamp0(tg.corpVisit);
  $("tg_corpContract").value = clamp0(tg.corpContract);
  $("tg_referralCards").value = clamp0(tg.referralCards);

  $("topics").value = state.topics || "";

  // listeners
  const markDirty = ()=>setSaveStatus("編集中…");

  $("periodStart").addEventListener("input", ()=>{
    markDirty();
    state.meta.periodStart = $("periodStart").value;
    $("periodLabel").textContent = derivePeriodLabel(state.meta.periodStart);
    saveState();
  });
  $("periodEnd").addEventListener("input", ()=>{
    markDirty();
    state.meta.periodEnd = $("periodEnd").value;
    $("asOfLabel").textContent = fmtJPDate(state.meta.periodEnd);
    saveState();
  });

  $("companyCount").addEventListener("input", ()=>{
    markDirty();
    state.counts.partnerCompanies = clamp0($("companyCount").value);
    saveState();
  });
  $("targetCount").addEventListener("input", ()=>{
    markDirty();
    state.counts.targetCompanies = clamp0($("targetCount").value);
    saveState();
  });

  const ids = [
    "v_totalVisit","v_totalContract","v_corpVisit","v_corpContract","v_referralCards",
    "ly_totalVisit","ly_totalContract","ly_corpVisit","ly_corpContract","ly_referralCards",
    "nm_totalVisit","nm_totalContract","nm_corpVisit","nm_corpContract","nm_referralCards",
    "tg_totalVisit","tg_totalContract","tg_corpVisit","tg_corpContract","tg_referralCards",
  ];
  ids.forEach(id=>{
    $(id).addEventListener("input", ()=>{
      markDirty();
      syncPerfFromUI();
      recalc();
      saveState();
    });
  });

  $("topics").addEventListener("input", ()=>{
    markDirty();
    state.topics = $("topics").value;
    saveState();
  });

  $("btnPrint").addEventListener("click", ()=>{
    window.open("./print.html", "_blank", "noopener");
  });

  $("btnShare").addEventListener("click", exportShareHTML);
}

function syncPerfFromUI(){
  state.perf.totalVisit = clamp0($("v_totalVisit").value);
  state.perf.totalContract = clamp0($("v_totalContract").value);
  state.perf.corpVisit = clamp0($("v_corpVisit").value);
  state.perf.corpContract = clamp0($("v_corpContract").value);
  state.perf.referralCards = clamp0($("v_referralCards").value);

  state.lastYear.totalVisit = clamp0($("ly_totalVisit").value);
  state.lastYear.totalContract = clamp0($("ly_totalContract").value);
  state.lastYear.corpVisit = clamp0($("ly_corpVisit").value);
  state.lastYear.corpContract = clamp0($("ly_corpContract").value);
  state.lastYear.referralCards = clamp0($("ly_referralCards").value);

  state.nextMonthPast.totalVisit = clamp0($("nm_totalVisit").value);
  state.nextMonthPast.totalContract = clamp0($("nm_totalContract").value);
  state.nextMonthPast.corpVisit = clamp0($("nm_corpVisit").value);
  state.nextMonthPast.corpContract = clamp0($("nm_corpContract").value);
  state.nextMonthPast.referralCards = clamp0($("nm_referralCards").value);

  state.nextTarget.totalVisit = clamp0($("tg_totalVisit").value);
  state.nextTarget.totalContract = clamp0($("tg_totalContract").value);
  state.nextTarget.corpVisit = clamp0($("tg_corpVisit").value);
  state.nextTarget.corpContract = clamp0($("tg_corpContract").value);
  state.nextTarget.referralCards = clamp0($("tg_referralCards").value);
}

function recalc(){
  const c = state.perf;
  const ly = state.lastYear;

  const k_ty  = pct(c.totalContract, c.totalVisit);
  const k_cvr = pct(c.corpVisit, c.totalVisit);
  const k_ccr = pct(c.corpContract, c.totalContract);
  const k_cy  = pct(c.corpContract, c.corpVisit);

  $("k_ty").textContent  = fmt1(k_ty);
  $("k_cvr").textContent = fmt1(k_cvr);
  $("k_ccr").textContent = fmt1(k_ccr);
  $("k_cy").textContent  = fmt1(k_cy);

  const ly_ty  = pct(ly.totalContract, ly.totalVisit);
  const ly_cvr = pct(ly.corpVisit, ly.totalVisit);
  const ly_ccr = pct(ly.corpContract, ly.totalContract);
  const ly_cy  = pct(ly.corpContract, ly.corpVisit);

  setDelta("d_ty",  k_ty,  ly_ty);
  setDelta("d_cvr", k_cvr, ly_cvr);
  setDelta("d_ccr", k_ccr, ly_ccr);
  setDelta("d_cy",  k_cy,  ly_cy);

  updateCharts();
}

/** ======================
 * Share HTML export (single file, embedded state)
 * ====================== */
function exportShareHTML(){
  setSaveStatus("出力中…");

  const fileName = `hb_report_${derivePeriodLabel(state.meta.periodStart).replace(".","-")}_shared.html`;
  const embedded = escapeHTML(JSON.stringify(state));

  const html = `<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HB Monthly Report（共有）</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#0b1220; --paper:#fff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --soft:#f1f5f9;
    --blue:#2563eb; --teal:#0ea5e9; --violet:#7c3aed; --amber:#f59e0b;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:'Noto Sans JP',system-ui,sans-serif; background:radial-gradient(1200px 700px at 10% 10%, #18223d, var(--bg)); padding:16px; display:flex; justify-content:center; }
  .app{ width:min(1360px,100%); background:var(--paper); border-radius:var(--radius); overflow:hidden; box-shadow:0 30px 60px -25px rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.10); }
  .topbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; padding:14px 16px; background:linear-gradient(90deg,#0f172a,#101c38); color:#fff; flex-wrap:wrap; }
  .brand{ display:flex; flex-direction:column; gap:3px; min-width:260px;}
  .brand h1{ margin:0; font-family:Montserrat,sans-serif; font-size:16px; letter-spacing:1px; }
  .brand .sub{ font-size:12px; opacity:.85; }
  .tabs{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .tab{ padding:9px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.08); font-weight:900; font-size:12px; cursor:pointer; color:#fff; }
  .tab.active{ background:rgba(37,99,235,.92); border-color:rgba(37,99,235,1); }
  .btn{ cursor:pointer; border:none; padding:10px 12px; border-radius:12px; font-weight:900; font-size:12px; color:#fff; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.16); }
  .btn.primary{ background:rgba(37,99,235,.92); border-color:rgba(37,99,235,1); }
  .chip{ padding:10px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.08); display:flex; gap:10px; align-items:center;}
  .chip .p{ font-family:Montserrat,sans-serif; font-weight:900; color:#93c5fd; font-size:13px; }
  .chip .s{ font-size:12px; opacity:.9; }

  .wrap{ padding:14px; background:linear-gradient(180deg,#fff,#f8fafc); }
  .grid{ display:grid; grid-template-columns:minmax(0,1fr) clamp(360px,34vw,520px); gap:14px; }
  @media (max-width: 1180px){ .grid{ grid-template-columns:1fr; } }

  .card{ background:#fff; border:1px solid var(--line); border-radius:var(--radius); padding:14px; box-shadow:0 14px 30px -24px rgba(15,23,42,.35); }
  .hrow{ display:flex; align-items:center; gap:10px; margin-bottom:10px; }
  .h2{ margin:0; font-size:14px; font-weight:900; display:flex; align-items:center; gap:10px; }
  .dot{ width:10px; height:10px; border-radius:4px; display:inline-block; }
  .dot.blue{ background:var(--blue);} .dot.teal{ background:var(--teal);} .dot.violet{ background:var(--violet);} .dot.amber{ background:var(--amber);}

  .kpis{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:10px; }
  @media (max-width: 720px){ .kpis{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
  .kpi{ border:1px solid var(--line); border-radius:14px; padding:12px; background:linear-gradient(180deg,#fff,#f8fafc); }
  .kpi .label{ font-size:11px; font-weight:900; color:var(--muted); }
  .kpi .val{ display:flex; align-items:baseline; gap:6px; margin-top:6px; }
  .kpi .num{ font-family:Montserrat,sans-serif; font-weight:900; font-size:28px; }
  .kpi .unit{ font-size:12px; font-weight:900; color:#94a3b8; }

  .highlights{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px;}
  @media (max-width: 720px){ .highlights{ grid-template-columns:1fr; } }
  .highlight{ border-radius:14px; border:1px solid var(--line); background:linear-gradient(180deg,#fff,#f8fafc); padding:12px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .highlight .t{ font-size:11px; font-weight:900; color:var(--muted); }
  .highlight .v{ font-family:Montserrat,sans-serif; font-weight:900; font-size:22px; }
  .badge{ font-size:11px; font-weight:900; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:var(--soft); color:var(--muted); white-space:nowrap; }

  .metricGrid{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px; }
  @media (max-width: 900px){ .metricGrid{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
  .mini{ border:1px solid var(--line); border-radius:12px; padding:10px; background:linear-gradient(180deg,#fff,#f8fafc); }
  .mini .t{ font-size:11px; font-weight:900; color:var(--muted); }
  .mini .v{ margin-top:4px; font-family:Montserrat,sans-serif; font-weight:900; font-size:18px; }

  .chart-wrap{ border:1px solid var(--line); border-radius:14px; padding:12px; background:#fff; overflow:hidden;}
  canvas{ max-width:100%; }

  .tbl-wrap{ overflow:auto; border:1px solid var(--line); border-radius:14px; }
  table{ width:100%; border-collapse:collapse; table-layout:fixed; }
  th{ background:var(--ink); color:#fff; font-size:11px; padding:10px; border:1px solid var(--ink); text-align:left; white-space:nowrap; }
  td{ border:1px solid var(--line); padding:8px; font-size:11px; vertical-align:top; word-break:break-word; }

  #topicsBox{ border:1px solid var(--line); border-radius:14px; padding:12px; background:linear-gradient(180deg,#fff,#fffef2); white-space:pre-wrap; line-height:1.7; font-size:13px; }

  /* view toggle */
  [data-view]{ display:none; }
  [data-view].active{ display:block; }

  /* PRINT */
  @media print{
    @page{ size:A4 landscape; margin:8mm; }
    body{ background:#fff; padding:0; }
    .app{ width:100%; border-radius:0; box-shadow:none; border:none; }
    .topbar{ display:none; }
    .wrap{ padding:0; background:#fff; }
    .pageBreak{ break-before:page; page-break-before:always; }
  }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <h1>HB Monthly Report（共有ファイル）</h1>
      <div class="sub">このファイル1つで閲覧・印刷できます（入力値は埋め込み済み）</div>
    </div>
    <div class="tabs">
      <button class="tab active" id="tab1">月報</button>
      <button class="tab" id="tab2">法人活動</button>
      <div class="chip">
        <div class="p" id="periodLabel">—</div>
        <div class="s" id="asofLabel">—</div>
      </div>
      <button class="btn primary" id="btnPrint">印刷（PDF）</button>
    </div>
  </div>

  <div class="wrap">
    <!-- VIEW 1 -->
    <div data-view="1" class="active">
      <div class="grid">
        <div style="display:flex; flex-direction:column; gap:14px; min-width:0;">
          <div class="card">
            <div class="hrow"><h2 class="h2"><span class="dot blue"></span>主要KPI</h2></div>
            <div class="kpis">
              <div class="kpi"><div class="label">総歩留り</div><div class="val"><span class="num" id="k_ty">0.0</span><span class="unit">%</span></div></div>
              <div class="kpi"><div class="label">法人来場比</div><div class="val"><span class="num" id="k_cvr">0.0</span><span class="unit">%</span></div></div>
              <div class="kpi"><div class="label">法人契約比</div><div class="val"><span class="num" id="k_ccr">0.0</span><span class="unit">%</span></div></div>
              <div class="kpi"><div class="label">法人歩留り</div><div class="val"><span class="num" id="k_cy">0.0</span><span class="unit">%</span></div></div>
            </div>

            <div class="highlights">
              <div class="highlight" style="border-left:6px solid var(--amber);">
                <div>
                  <div class="t">提携会社数</div>
                  <div class="v" id="partnerCompanies">0</div>
                </div>
                <div class="badge" id="asOfText">—</div>
              </div>
              <div class="highlight" style="border-left:6px solid var(--violet);">
                <div>
                  <div class="t">対象企業総数</div>
                  <div class="v" id="targetCompanies">0</div>
                </div>
                <div class="badge">TARGETS</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="hrow"><h2 class="h2"><span class="dot teal"></span>当月実績</h2></div>
            <div class="metricGrid">
              <div class="mini"><div class="t">総来場</div><div class="v" id="tv">0</div></div>
              <div class="mini"><div class="t">総契約</div><div class="v" id="tc">0</div></div>
              <div class="mini"><div class="t">法人来場</div><div class="v" id="cv">0</div></div>
              <div class="mini"><div class="t">法人契約</div><div class="v" id="cc">0</div></div>
              <div class="mini"><div class="t">紹介カード</div><div class="v" id="rc">0</div></div>
            </div>
          </div>

          <div class="card">
            <div class="hrow"><h2 class="h2"><span class="dot violet"></span>Topics</h2></div>
            <div id="topicsBox">—</div>
          </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:14px; min-width:0;">
          <div class="card">
            <div class="hrow"><h2 class="h2"><span class="dot blue"></span>KPI（%）当月 vs 前年同月</h2></div>
            <div class="chart-wrap"><canvas id="chartKPI" height="210"></canvas></div>
          </div>
          <div class="card">
            <div class="hrow"><h2 class="h2"><span class="dot teal"></span>ファネル（上限30%）</h2></div>
            <div class="chart-wrap"><canvas id="chartFunnel" height="210"></canvas></div>
          </div>
          <div class="card">
            <div class="hrow"><h2 class="h2"><span class="dot teal"></span>法人比率（来場）</h2></div>
            <div class="chart-wrap"><canvas id="chartShare" height="230"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW 2 -->
    <div data-view="2">
      <div class="card" style="margin-bottom:14px;">
        <div class="hrow"><h2 class="h2"><span class="dot teal"></span>当月 法人活動サマリー</h2></div>
        <div class="metricGrid">
          <div class="mini"><div class="t">法人来場</div><div class="v" id="s_cv">0</div></div>
          <div class="mini"><div class="t">法人契約</div><div class="v" id="s_cc">0</div></div>
          <div class="mini"><div class="t">PR費用（合計）</div><div class="v" id="s_cost">0</div></div>
          <div class="mini"><div class="t">来場CPA（合計）</div><div class="v" id="s_cpa">0.0</div></div>
        </div>
      </div>

      <div class="card" style="margin-bottom:14px;">
        <div class="hrow"><h2 class="h2"><span class="dot amber"></span>現提携（活動・PR・単価）</h2></div>
        <div class="tbl-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:150px;">企業名</th>
                <th style="width:160px;">対象物件</th>
                <th style="width:60px;">来場</th>
                <th style="width:60px;">初回</th>
                <th style="width:60px;">申込</th>
                <th style="width:60px;">契約</th>
                <th style="width:220px;">PR内容</th>
                <th style="width:100px;">費用</th>
                <th style="width:110px;">来場CPA</th>
                <th style="width:120px;">成約獲得単価</th>
                <th style="width:160px;">特典</th>
                <th style="width:90px;">手数料</th>
                <th>備考</th>
              </tr>
            </thead>
            <tbody id="tblPartners"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="hrow"><h2 class="h2"><span class="dot violet"></span>法人業務提携（予定・交渉中）</h2></div>
        <div class="tbl-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:170px;">企業名</th>
                <th style="width:140px;">企業規模</th>
                <th>提案内容</th>
                <th style="width:150px;">ステータス</th>
                <th style="width:180px;">次アクション</th>
                <th style="width:120px;">予定時期</th>
              </tr>
            </thead>
            <tbody id="tblPlanned"></tbody>
          </table>
        </div>
      </div>

      <div class="pageBreak"></div>
    </div>
  </div>
</div>

<script id="__STATE__" type="application/json">${embedded}</script>
<script>
  function unescapeHTML(s){ return s.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"); }
  const state = JSON.parse(unescapeHTML(document.getElementById("__STATE__").textContent));
  const clamp0 = (v)=>{ const n=Number(v); return Number.isFinite(n)&&n>0?n:0; };
  const pct = (a,b)=> (b>0) ? (a/b)*100 : 0;
  const fmt1 = (n)=> (Number.isFinite(n)?n:0).toFixed(1);
  const nf = new Intl.NumberFormat("ja-JP");
  const pad2 = (n)=>String(n).padStart(2,"0");

  function fmtJPDate(iso){
    if(!iso) return "—";
    const [y,m,d] = iso.split("-").map(Number);
    if(!y||!m||!d) return "—";
    return \`\${y}年\${pad2(m)}月\${pad2(d)}日現在\`;
  }
  function periodLabel(isoStart){
    if(!isoStart) return "—";
    const [y,m] = isoStart.split("-").map(Number);
    return \`\${y}.\${pad2(m)}\`;
  }
  function computeCPA(cost, denom){
    cost = clamp0(cost); denom = clamp0(denom);
    return denom>0 ? (cost/denom) : 0;
  }

  // tabs
  const tab1 = document.getElementById("tab1");
  const tab2 = document.getElementById("tab2");
  const v1 = document.querySelector('[data-view="1"]');
  const v2 = document.querySelector('[data-view="2"]');
  tab1.onclick = ()=>{ tab1.classList.add("active"); tab2.classList.remove("active"); v1.classList.add("active"); v2.classList.remove("active"); };
  tab2.onclick = ()=>{ tab2.classList.add("active"); tab1.classList.remove("active"); v2.classList.add("active"); v1.classList.remove("active"); };

  document.getElementById("btnPrint").onclick = ()=> window.print();

  // header
  document.getElementById("periodLabel").textContent = periodLabel(state.meta?.periodStart);
  document.getElementById("asofLabel").textContent = "入力値埋め込み済み";
  document.getElementById("asOfText").textContent = fmtJPDate(state.meta?.periodEnd);

  // numbers
  document.getElementById("partnerCompanies").textContent = nf.format(clamp0(state.counts?.partnerCompanies));
  document.getElementById("targetCompanies").textContent = nf.format(clamp0(state.counts?.targetCompanies));

  const c = state.perf || {};
  const ly = state.lastYear || {};

  document.getElementById("tv").textContent = nf.format(clamp0(c.totalVisit));
  document.getElementById("tc").textContent = nf.format(clamp0(c.totalContract));
  document.getElementById("cv").textContent = nf.format(clamp0(c.corpVisit));
  document.getElementById("cc").textContent = nf.format(clamp0(c.corpContract));
  document.getElementById("rc").textContent = nf.format(clamp0(c.referralCards));
  document.getElementById("topicsBox").textContent = (state.topics||"").trim() || "—";

  const k_ty  = pct(clamp0(c.totalContract), clamp0(c.totalVisit));
  const k_cvr = pct(clamp0(c.corpVisit), clamp0(c.totalVisit));
  const k_ccr = pct(clamp0(c.corpContract), clamp0(c.totalContract));
  const k_cy  = pct(clamp0(c.corpContract), clamp0(c.corpVisit));
  document.getElementById("k_ty").textContent = fmt1(k_ty);
  document.getElementById("k_cvr").textContent = fmt1(k_cvr);
  document.getElementById("k_ccr").textContent = fmt1(k_ccr);
  document.getElementById("k_cy").textContent = fmt1(k_cy);

  // page2 summary
  document.getElementById("s_cv").textContent = nf.format(clamp0(c.corpVisit));
  document.getElementById("s_cc").textContent = nf.format(clamp0(c.corpContract));
  const totalCost = (state.partners||[]).reduce((s,p)=> s + clamp0(p.cost), 0);
  const totalVisit = (state.partners||[]).reduce((s,p)=> s + clamp0(p.visit), 0);
  document.getElementById("s_cost").textContent = nf.format(totalCost);
  document.getElementById("s_cpa").textContent = (computeCPA(totalCost, totalVisit)).toFixed(1);

  // tables
  const tb = document.getElementById("tblPartners");
  tb.innerHTML = "";
  (state.partners||[]).forEach(p=>{
    const hasAny = ["name","property","pr","benefit","note"].some(k=> (p[k]||"").toString().trim())
      || [p.visit,p.first,p.apply,p.contract,p.cost,p.fee].some(v=> clamp0(v)>0);
    if(!hasAny) return;

    const tr = document.createElement("tr");
    const td = (t)=>{ const x=document.createElement("td"); x.textContent = t; return x; };
    tr.appendChild(td((p.name||"").trim()));
    tr.appendChild(td((p.property||"").trim()));
    tr.appendChild(td(String(clamp0(p.visit))));
    tr.appendChild(td(String(clamp0(p.first))));
    tr.appendChild(td(String(clamp0(p.apply))));
    tr.appendChild(td(String(clamp0(p.contract))));
    tr.appendChild(td((p.pr||"").trim()));
    tr.appendChild(td(String(clamp0(p.cost))));
    tr.appendChild(td(computeCPA(p.cost, p.visit).toFixed(1)));
    tr.appendChild(td(computeCPA(p.cost, p.contract).toFixed(1)));
    tr.appendChild(td((p.benefit||"").trim()));
    tr.appendChild(td(String(clamp0(p.fee))));
    tr.appendChild(td((p.note||"").trim()));
    tb.appendChild(tr);
  });

  const tp = document.getElementById("tblPlanned");
  tp.innerHTML = "";
  (state.planned||[]).forEach(p=>{
    const hasAny = ["name","companySize","proposal","status","nextAction","schedule"].some(k=> (p[k]||"").toString().trim());
    if(!hasAny) return;
    const tr = document.createElement("tr");
    const td = (t)=>{ const x=document.createElement("td"); x.textContent=t; return x; };
    tr.appendChild(td((p.name||"").trim()));
    tr.appendChild(td((p.companySize||"").trim()));
    tr.appendChild(td((p.proposal||"").trim()));
    tr.appendChild(td((p.status||"").trim()));
    tr.appendChild(td((p.nextAction||"").trim()));
    tr.appendChild(td((p.schedule||"").trim()));
    tp.appendChild(tr);
  });

  // charts (if CDN blocked, skip)
  if(typeof Chart === "undefined"){
    console.warn("Chart.js が読み込めません（ネットワーク制限の可能性）。グラフは非表示になります。");
  }else{
    const centerLabelPlugin = {
      id: "centerLabel",
      afterDraw(chart){
        if(chart.config.type !== "doughnut") return;
        const {ctx, chartArea} = chart;
        if(!chartArea) return;
        const data = chart.data.datasets?.[0]?.data || [];
        const corp = Number(data[0] || 0);
        const total = data.reduce((a,b)=>a+Number(b||0), 0);
        const p = total ? (corp/total*100) : 0;
        const cx = (chartArea.left + chartArea.right)/2;
        const cy = (chartArea.top + chartArea.bottom)/2;
        ctx.save();
        ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillStyle="#0f172a"; ctx.font="800 28px Montserrat, sans-serif";
        ctx.fillText(p.toFixed(1)+"%", cx, cy-6);
        ctx.fillStyle="#64748b"; ctx.font="700 12px Noto Sans JP, sans-serif";
        ctx.fillText("法人比率（来場）", cx, cy+18);
        ctx.restore();
      }
    };
    Chart.register(centerLabelPlugin);

    const ly_ty  = pct(clamp0(ly.totalContract), clamp0(ly.totalVisit));
    const ly_cvr = pct(clamp0(ly.corpVisit), clamp0(ly.totalVisit));
    const ly_ccr = pct(clamp0(ly.corpContract), clamp0(ly.totalContract));
    const ly_cy  = pct(clamp0(ly.corpContract), clamp0(ly.corpVisit));

    new Chart(document.getElementById("chartKPI"),{
      type:"bar",
      data:{
        labels:["総歩留り","法人来場比","法人契約比","法人歩留り"],
        datasets:[
          { label:"当月", data:[Number(fmt1(k_ty)),Number(fmt1(k_cvr)),Number(fmt1(k_ccr)),Number(fmt1(k_cy))],
            backgroundColor:"rgba(37,99,235,0.35)", borderColor:"rgba(37,99,235,1)", borderWidth:1 },
          { label:"前年同月", data:[Number(fmt1(ly_ty)),Number(fmt1(ly_cvr)),Number(fmt1(ly_ccr)),Number(fmt1(ly_cy))],
            backgroundColor:"rgba(244,63,94,0.25)", borderColor:"rgba(244,63,94,1)", borderWidth:1 }
        ]
      },
      options:{ responsive:true, plugins:{legend:{position:"top"}}, scales:{ y:{ beginAtZero:true, suggestedMax:30, ticks:{ callback:(v)=>v+"%" } } } }
    });

    new Chart(document.getElementById("chartFunnel"),{
      type:"bar",
      data:{ labels:["来場 → 契約","法人来場 → 法人契約"], datasets:[{ data:[Number(fmt1(k_ty)),Number(fmt1(k_cy))], backgroundColor:"rgba(14,165,233,0.35)", borderColor:"rgba(14,165,233,1)", borderWidth:1 }] },
      options:{ indexAxis:"y", responsive:true, plugins:{legend:{display:false}}, scales:{ x:{ beginAtZero:true, suggestedMax:30, ticks:{ callback:(v)=>v+"%" } } } }
    });

    const nonCorp = Math.max(0, clamp0(c.totalVisit) - clamp0(c.corpVisit));
    new Chart(document.getElementById("chartShare"),{
      type:"doughnut",
      data:{ labels:["法人","非法人"], datasets:[{ data:[clamp0(c.corpVisit), nonCorp], backgroundColor:["rgba(37,99,235,0.55)","rgba(244,63,94,0.35)"], borderColor:["rgba(37,99,235,1)","rgba(244,63,94,1)"], borderWidth:1, cutout:"62%" }] },
      options:{ responsive:true, plugins:{ legend:{ position:"bottom" } } }
    });
  }
</script>
</body>
</html>`;

  const blob = new Blob([html], {type:"text/html;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = fileName;
  a.click();
  URL.revokeObjectURL(url);

  setSaveStatus("保存済み");
}
