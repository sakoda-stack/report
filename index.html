<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Business Monthly Report</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --paper:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#cbd5e1;
      
      /* === グループ定義色 === */
      /* Group 1: 当月実績 & KPI (Blue/Cyan) */
      --g1-bg: #eff6ff; --g1-bd: #bfdbfe; --g1-acc: #3b82f6; --g1-sub: #0ea5e9;
      
      /* Group 2: 次月関連 (Purple/Indigo) */
      --g2-bg: #f5f3ff; --g2-bd: #ddd6fe; --g2-acc: #8b5cf6; --g2-sub: #6366f1;

      /* Group 3: 提携先 (Orange/Amber) */
      --g3-bg: #fff7ed; --g3-bd: #fed7aa; --g3-acc: #f97316; --g3-sub: #f59e0b;

      /* Topics (Neutral/Dark) */
      --tp-bg: #f8fafc; --tp-bd: #e2e8f0; --tp-acc: #475569;

      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Noto Sans JP',system-ui,sans-serif;
      background: radial-gradient(1200px 700px at 10% 10%, #1e293b, var(--bg));
      color:var(--ink);
      padding:20px;
      display:flex; justify-content:center;
      overflow-x:auto;
    }

    .app{
      width:min(1320px, 100%);
      background:#f1f5f9;
      border-radius:var(--radius);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      border:1px solid rgba(255,255,255,0.05);
      overflow-x:auto; overflow-y:visible;
    }

    /* Top bar */
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:16px 20px;
      background:#0f172a;
      color:#fff;
      border-bottom:1px solid #1e293b;
      flex-wrap:wrap;
    }
    .nav{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .tab{
      color:#94a3b8; text-decoration:none; font-weight:800; font-size:12px;
      padding:8px 12px; border-radius:999px; transition:.2s;
    }
    .tab:hover{ color:#fff; background:rgba(255,255,255,.1); }
    .tab.active{ background:rgba(37,99,235,1); color:#fff; box-shadow: 0 0 10px rgba(37,99,235,0.5); }
    
    .title h1{ margin:0; font-family:'Montserrat',sans-serif; letter-spacing:1px; font-size:18px; font-weight:800; }
    .title .sub{ font-size:11px; opacity:.7; margin-top:4px; }

    .top-controls{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:flex-end; flex:1 1 auto; min-width: 280px; }
    .chip{ display:flex;align-items:center;gap:10px; background:#1e293b; padding:8px 14px; border-radius:999px; border:1px solid #334155; }
    .chip .p{ font-family:'Montserrat',sans-serif; font-weight:800; color:#60a5fa; font-size:14px; }
    .chip .status{ font-size:11px; opacity:.8; }

    .date-range{ display:flex; gap:8px; align-items:center; padding:8px 12px; border-radius:999px; background:#1e293b; border:1px solid #334155; }
    .date-range label{ font-size:11px; color:#cbd5e1; font-weight:700; }
    .date-range input{ border:none; outline:none; padding:4px 8px; border-radius:6px; background:#334155; color:#fff; font-weight:700; font-size:12px; }
    .date-range input::-webkit-calendar-picker-indicator{ filter: invert(1); opacity:.8; cursor:pointer; }

    .actions{ display:flex; gap:8px; }
    .btn{ cursor:pointer; padding:8px 12px; border-radius:8px; font-weight:700; font-size:12px; color:#fff; background:#334155; border:1px solid #475569; transition:.2s; }
    .btn:hover{ background:#475569; }
    .btn.primary{ background:#2563eb; border-color:#3b82f6; }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: minmax(0, 1fr) clamp(360px, 34vw, 520px);
      gap:20px; padding:20px;
      background:#f8fafc;
    }
    @media (max-width: 1180px){ .grid{ grid-template-columns: 1fr; } }

    /* ========== Cards & Themes ========== */
    .card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
      display:flex; flex-direction:column; gap:10px;
    }
    
    /* グループ配色 */
    /* Group 1: Blue/Cyan */
    .card.g1 { background: var(--g1-bg); border-color: var(--g1-bd); border-top: 5px solid var(--g1-acc); }
    .card.g1 .h2 { color: var(--g1-acc); }
    
    /* Group 2: Purple */
    .card.g2 { background: var(--g2-bg); border-color: var(--g2-bd); border-top: 5px solid var(--g2-acc); }
    .card.g2 .h2 { color: var(--g2-acc); }

    /* Group 3: Orange */
    .card.g3 { background: var(--g3-bg); border-color: var(--g3-bd); border-top: 5px solid var(--g3-acc); }
    .card.g3 .h2 { color: var(--g3-acc); }

    /* Topics: Full Width */
    .card.topics { background: var(--tp-bg); border-color: var(--tp-bd); border-top: 5px solid var(--tp-acc); grid-column: 1 / -1; }
    .card.topics .h2 { color: var(--tp-acc); }

    .hrow{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:4px; }
    .h2{ margin:0; font-size:16px; font-weight:800; display:flex; align-items:center; gap:8px; }
    .subline{ font-size:11px; color:var(--muted); font-weight:600; }
    .subline strong{ color:var(--ink); font-weight:800; }

    /* Metric Box (Input Areas) */
    .metric-box{
      background:#fff; border:1px solid rgba(0,0,0,0.08); border-radius:12px; padding:12px; box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    .metric-head{ display:flex; justify-content:space-between; align-items:baseline; margin-bottom:8px; }
    .metric-title{ font-size:13px; font-weight:800; color:var(--ink); margin:0; }
    .metric-period{ font-size:11px; color:var(--muted); font-weight:700; }
    
    .metric-grid{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
    .metric{ padding:6px 0; }
    .metric .mlabel{ font-size:11px; font-weight:700; color:var(--muted); margin-bottom:4px; }
    .metric .mrow{ display:flex; gap:6px; align-items:baseline; }
    
    .metric input{
      width:100%; border:1px solid #cbd5e1; outline:none; padding:8px 10px; border-radius:8px;
      background:#fff; font-family:'Montserrat',sans-serif; font-weight:700; font-size:18px; text-align:right; transition: .15s;
    }
    .metric input:focus{ border-color:var(--g1-acc); box-shadow:0 0 0 3px rgba(59,130,246,0.15); }
    .metric .unit{ font-size:11px; font-weight:700; color:#94a3b8; }

    /* KPI Cards */
    .kpis{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; }
    .kpi{ border:1px solid #fff; border-radius:12px; padding:12px; background:rgba(255,255,255,0.7); text-align:center; }
    .kpi .label{ font-size:10px; font-weight:700; color:var(--muted); height:2.4em; display:flex; align-items:center; justify-content:center; }
    .kpi .val{ margin-top:4px; }
    .kpi .num{ font-family:'Montserrat',sans-serif; font-weight:800; font-size:26px; color:var(--ink); }
    .delta{ margin-top:6px; font-size:10px; font-weight:700; display:flex; justify-content:center; gap:4px; }
    .delta.good{ color:#16a34a; } .delta.bad{ color:#dc2626; } .delta.neutral{ color:var(--muted); }

    /* Highlights (Counts) */
    .highlights{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .highlight{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; display:flex; justify-content:space-between; align-items:center; }
    .big-input{ width:120px; border:1px solid #cbd5e1; border-radius:8px; padding:4px 8px; font-family:'Montserrat',sans-serif; font-weight:800; font-size:24px; text-align:right; color:var(--ink); background:#fff; }
    .big-input:focus{ outline:none; border-color:var(--g3-acc); box-shadow:0 0 0 3px rgba(249,115,22,0.2); }
    .badge{ font-size:10px; font-weight:800; padding:4px 8px; border-radius:999px; background:#f1f5f9; color:#64748b; }

    /* Charts */
    .chart-wrap{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; }

    /* Table */
    table{ width:100%; border-collapse:collapse; table-layout:fixed; }
    th{ text-align:left; font-size:11px; color:#fff; background:var(--g3-acc); padding:8px; white-space:nowrap; }
    th.center, td.center{ text-align:center; }
    td{ border:1px solid #e2e8f0; padding:4px; background:#fff; vertical-align:middle; }
    td input{ width:100%; border:none; outline:none; padding:6px; font-size:13px; background:transparent; }
    td input:focus{ background:#fff7ed; }
    
    /* Table Footer for Totals */
    tfoot td {
      background: #fff7ed; border-top: 2px solid var(--g3-acc);
      font-weight: 800; font-family: 'Montserrat', sans-serif;
      text-align: center; padding: 8px 4px;
      font-size: 13px; color: var(--g3-acc);
    }
    tfoot td.label { text-align: right; color: var(--muted); font-family: sans-serif; padding-right: 10px; }

    .icon-btn{ cursor:pointer; border:1px solid #e2e8f0; background:#fff; width:28px; height:28px; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; }
    .icon-btn:hover{ background:#fee2e2; border-color:#fecaca; }

    /* Topics */
    textarea#topics{
      width:100%; min-height:160px; padding:16px; border-radius:12px;
      border:1px solid var(--line); outline:none; resize:vertical;
      font-size:14px; line-height:1.7; background:#fff;
    }
    textarea#topics:focus{ border-color:var(--tp-acc); box-shadow:0 0 0 3px rgba(71,85,105,0.15); }

    /* Print */
    @media print{
      @page { size: A4 landscape; margin: 5mm; }
      body{ background:#fff; padding:0; display:block; zoom:0.9; }
      .app{ width:100%; border:none; box-shadow:none; background:#fff; }
      .actions, .btn, .no-print{ display:none !important; }
      .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:15px; padding:0; background:#fff; }
      .card{ break-inside:avoid; border:1px solid #ccc; box-shadow:none; padding:10px; }
      .card.topics { break-before: always; }
      .metric input, .big-input{ border:none; background:transparent; padding:0; text-align:right; }
      .metric-box{ border:1px solid #eee; }
      .card[class*="g"] { background: #fff !important; border-top-width: 2px; }
      tfoot td { background: #fff; border-top: 2px solid #000; color: #000; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="title">
        <h1>BUSINESS MONTHLY REPORT</h1>
        <div class="sub">入力 → 自動集計 → KPI可視化 → 目標明示 → 自動保存</div>
      </div>

      <div class="nav">
        <a class="tab active" href="./index.html">月報</a>
        <a class="tab" href="./page2.html">法人活動</a>
        <a class="tab" href="./view.html">閲覧</a>
        <a class="tab" href="./print.html" target="_blank" rel="noopener">PDF印刷</a>
      </div>

      <div class="top-controls">
        <div class="chip">
          <div class="p" id="periodLabel">—</div>
          <div class="status" id="saveStatus">未保存</div>
        </div>

        <div class="date-range">
          <label>当月期間</label>
          <input type="date" id="periodStart">
          <span style="opacity:.5; color:#fff;">–</span>
          <input type="date" id="periodEnd">
        </div>

        <div class="actions">
          <button class="btn" id="btnImport">JSON取込</button>
          <button class="btn" id="btnExport">JSON出力</button>
          <button class="btn" id="btnReset">初期値</button>
          <button class="btn primary" id="btnPrint">PDF印刷</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <div style="display:flex;flex-direction:column;gap:20px;min-width:0;">

        <div class="card g1">
          <div class="hrow">
            <h2 class="h2">当月実績・過去実績</h2>
            <div class="subline">期間：<strong id="lblRangeCur">-</strong></div>
          </div>

          <div class="metric-wrap" style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <div class="metric-box">
              <div class="metric-head">
                <p class="metric-title">当月実績</p>
                <div class="metric-period" id="lblPeriodCur">-</div>
              </div>
              <div class="metric-grid">
                <div class="metric">
                  <div class="mlabel">総来場</div>
                  <div class="mrow"><input type="number" id="v_totalVisit" min="0"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">総契約</div>
                  <div class="mrow"><input type="number" id="v_totalContract" min="0"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">法人来場</div>
                  <div class="mrow"><input type="number" id="v_corpVisit" min="0"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">法人契約</div>
                  <div class="mrow"><input type="number" id="v_corpContract" min="0"><span class="unit">件</span></div>
                </div>
                <div class="metric" style="grid-column:1 / -1;">
                  <div class="mlabel">紹介カード</div>
                  <div class="mrow"><input type="number" id="v_referralCards" min="0"><span class="unit">枚</span></div>
                </div>
              </div>
            </div>

            <div class="metric-box">
              <div class="metric-head">
                <p class="metric-title">前年同月</p>
                <div class="metric-period" id="lblPeriodLY">-</div>
              </div>
              <div class="metric-grid">
                <div class="metric">
                  <div class="mlabel">総来場</div>
                  <div class="mrow"><input type="number" id="ly_totalVisit" min="0"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">総契約</div>
                  <div class="mrow"><input type="number" id="ly_totalContract" min="0"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">法人来場</div>
                  <div class="mrow"><input type="number" id="ly_corpVisit" min="0"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">法人契約</div>
                  <div class="mrow"><input type="number" id="ly_corpContract" min="0"><span class="unit">件</span></div>
                </div>
                <div class="metric" style="grid-column:1 / -1;">
                  <div class="mlabel">紹介カード</div>
                  <div class="mrow"><input type="number" id="ly_referralCards" min="0"><span class="unit">枚</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card g1">
          <div class="hrow">
            <h2 class="h2">主要KPIダッシュボード</h2>
            <div class="subline">当月 <strong id="lblCurMonth">—</strong> vs 前年</div>
          </div>

          <div class="kpis">
            <div class="kpi">
              <div class="label">総歩留り<br>(契約/来場)</div>
              <div class="val"><span class="num" id="k_ty">0.0</span><span class="unit">%</span></div>
              <div class="delta neutral" id="d_ty"></div>
            </div>
            <div class="kpi">
              <div class="label">法人来場比<br>(法人/全体)</div>
              <div class="val"><span class="num" id="k_cvr">0.0</span><span class="unit">%</span></div>
              <div class="delta neutral" id="d_cvr"></div>
            </div>
            <div class="kpi">
              <div class="label">法人契約比<br>(法人/総契)</div>
              <div class="val"><span class="num" id="k_ccr">0.0</span><span class="unit">%</span></div>
              <div class="delta neutral" id="d_ccr"></div>
            </div>
            <div class="kpi">
              <div class="label">法人歩留り<br>(法契/法来)</div>
              <div class="val"><span class="num" id="k_cy">0.0</span><span class="unit">%</span></div>
              <div class="delta neutral" id="d_cy"></div>
            </div>
          </div>
        </div>

        <div class="card g2">
          <div class="hrow">
            <h2 class="h2">次月過去実績・次月目標</h2>
            <div class="subline">Next Month Strategy</div>
          </div>

          <div class="metric-wrap" style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <div class="metric-box">
              <div class="metric-head">
                <p class="metric-title">次月過去実績</p>
                <div class="metric-period" id="lblPeriodNextPast">-</div>
              </div>
              <div class="metric-grid">
                <div class="metric">
                  <div class="mlabel">総来場</div>
                  <div class="mrow"><input type="number" id="nm_totalVisit" min="0"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">総契約</div>
                  <div class="mrow"><input type="number" id="nm_totalContract" min="0"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">法人来場</div>
                  <div class="mrow"><input type="number" id="nm_corpVisit" min="0"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">法人契約</div>
                  <div class="mrow"><input type="number" id="nm_corpContract" min="0"><span class="unit">件</span></div>
                </div>
                
                <div class="metric" style="grid-column:1 / -1; margin-top:8px;">
                   <div style="background:#f5f3ff; padding:8px; border-radius:8px; display:flex; justify-content:space-around;">
                      <div style="text-align:center;">
                        <div style="font-size:10px; color:#8b5cf6; font-weight:700;">法人来場割合</div>
                        <div style="font-weight:800; font-size:16px;" id="nm_k_cvr">0.0%</div>
                      </div>
                      <div style="text-align:center;">
                        <div style="font-size:10px; color:#8b5cf6; font-weight:700;">法人歩留り</div>
                        <div style="font-weight:800; font-size:16px;" id="nm_k_cy">0.0%</div>
                      </div>
                   </div>
                </div>
              </div>
            </div>

            <div class="metric-box">
              <div class="metric-head">
                <p class="metric-title">次月目標</p>
                <div class="metric-period" id="lblPeriodNextTarget">-</div>
              </div>
              <div class="metric-grid">
                <div class="metric">
                  <div class="mlabel">総来場（目標）</div>
                  <div class="mrow"><input type="number" id="tg_totalVisit" min="0"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">総契約（目標）</div>
                  <div class="mrow"><input type="number" id="tg_totalContract" min="0"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">法人来場（目標）</div>
                  <div class="mrow"><input type="number" id="tg_corpVisit" min="0"><span class="unit">件</span></div>
                </div>
                <div class="metric">
                  <div class="mlabel">法人契約（目標）</div>
                  <div class="mrow"><input type="number" id="tg_corpContract" min="0"><span class="unit">件</span></div>
                </div>

                <div class="metric" style="grid-column:1 / -1; margin-top:8px;">
                   <div style="background:#fff; border:1px solid #ddd6fe; padding:8px; border-radius:8px; display:flex; justify-content:space-around;">
                      <div style="text-align:center;">
                        <div style="font-size:10px; color:#6366f1; font-weight:700;">目標: 法人割合</div>
                        <div style="font-weight:800; font-size:16px; color:#6366f1;" id="tg_k_cvr">0.0%</div>
                      </div>
                      <div style="text-align:center;">
                        <div style="font-size:10px; color:#6366f1; font-weight:700;">目標: 法人歩留り</div>
                        <div style="font-weight:800; font-size:16px; color:#6366f1;" id="tg_k_cy">0.0%</div>
                      </div>
                   </div>
                   <div id="tg_hint_cy" style="display:none;"></div>
                </div>
              </div>
            </div>
            
             <div class="metric-box" style="grid-column:1/-1; display:flex; gap:20px; align-items:center;">
               <div style="flex:1;">
                 <div class="mlabel">次月過去: 紹介カード</div>
                 <div class="mrow"><input type="number" id="nm_referralCards" min="0"><span class="unit">枚</span></div>
               </div>
               <div style="flex:1;">
                 <div class="mlabel">次月目標: 紹介カード</div>
                 <div class="mrow"><input type="number" id="tg_referralCards" min="0"><span class="unit">枚</span></div>
               </div>
             </div>
          </div>
        </div>

        <div class="card g3">
          <div class="hrow">
            <h2 class="h2">提携会社数・対象企業数</h2>
            <div class="subline"><strong id="badgeCoverage">—</strong></div>
          </div>

          <div class="highlights">
            <div class="highlight">
              <div class="left">
                <div class="subline">提携会社数</div>
                <input class="big-input" type="number" id="companyCount" min="0">
              </div>
              <div class="badge">PARTNERS</div>
            </div>

            <div class="highlight">
              <div class="left">
                <div class="subline">対象企業総数</div>
                <input class="big-input" type="number" id="targetCount" min="0">
              </div>
              <div class="badge">TARGETS</div>
            </div>
          </div>
        </div>

        <div class="card g3">
          <div class="hrow">
            <h2 class="h2">提携先（簡易入力・集計）</h2>
          </div>

          <div class="print-hide" style="overflow:hidden;">
            <table>
              <colgroup>
                <col style="width:20%;">
                <col style="width:46%;">
                <col style="width:7%;">
                <col style="width:7%;">
                <col style="width:7%;">
                <col style="width:7%;">
                <col style="width:6%;">
              </colgroup>
              <thead>
                <tr>
                  <th>パートナー企業名</th>
                  <th>対象物件名</th>
                  <th class="center">来場</th>
                  <th class="center">契約</th>
                  <th class="center">初回</th>
                  <th class="center">申込</th>
                  <th class="center">削除</th>
                </tr>
              </thead>
              <tbody id="partnersBody"></tbody>
              <tfoot>
                <tr>
                  <td colspan="2" class="label">合計</td>
                  <td id="t_visit">0</td>
                  <td id="t_contract">0</td>
                  <td id="t_first">0</td>
                  <td id="t_apply">0</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="tbl-actions print-hide" style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
            <button class="btn primary" id="btnAddRow" style="background:#f97316; border-color:#ea580c;">+ 行追加</button>
            <span class="subline">※初回・申込は「紹介カード」の件数</span>
          </div>
        </div>
      </div>

      <div class="right-col" style="display:flex;flex-direction:column;gap:20px;min-width:0;">

        <div class="card g1">
          <div class="hrow">
            <h2 class="h2">KPI（%） 当月 vs 前年</h2>
          </div>
          <div class="chart-wrap">
            <canvas id="chartKPI" height="200"></canvas>
          </div>
        </div>

        <div class="card g1">
          <div class="hrow">
            <h2 class="h2">ファネル（歩留り）</h2>
            <div class="subline">目安 30%</div>
          </div>
          <div class="chart-wrap">
            <canvas id="chartFunnel" height="210"></canvas>
          </div>
        </div>

        <div class="card g1">
          <div class="hrow">
            <h2 class="h2">法人比率（来場）</h2>
            <div class="subline">目標 8～10%</div>
          </div>
          <div class="chart-wrap">
            <canvas id="chartShare" height="180"></canvas>
          </div>
        </div>

        <div class="card g3">
          <div class="hrow">
            <h2 class="h2">提携先 上位（活動状況）</h2>
          </div>
          <div class="chart-wrap">
            <canvas id="chartPartners" height="240"></canvas>
          </div>
        </div>
      </div>

      <div class="card topics">
         <div class="hrow">
           <h2 class="h2">Topics / Memo</h2>
         </div>
         <textarea id="topics" placeholder="・今月の特筆事項&#10;・新規提携企業の反応&#10;・次月へのアクション"></textarea>
      </div>

    </div>
  </div>

<script>
(function(){
  const clone = (obj) => (window.structuredClone ? structuredClone(obj) : JSON.parse(JSON.stringify(obj)));
  const pad2 = (n) => String(n).padStart(2,"0");
  const toISO = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const fmtJP = (iso) => {
    if(!iso) return "-";
    const [y,m,d] = String(iso).split("-").map(Number);
    return `${y}/${pad2(m)}/${pad2(d)}`;
  };
  function monthStartEnd(year, month1to12){
    const start = new Date(year, month1to12-1, 1);
    const end = new Date(year, month1to12, 0);
    return { start: toISO(start), end: toISO(end) };
  }
  function addMonths(year, month1to12, delta){
    let m = (month1to12 - 1) + delta;
    let y = year + Math.floor(m / 12);
    m = m % 12;
    if(m < 0){ m += 12; y -= 1; }
    return { year: y, month: m+1 };
  }
  function derivePeriodLabelFromStart(isoStart){
    if(!isoStart) return "—";
    const [y,m] = String(isoStart).split("-").map(Number);
    if(!y || !m) return "—";
    return `${y}.${pad2(m)}`;
  }
  function monthNowLabel(isoStart){
    if(!isoStart) return "—";
    const [y,m] = String(isoStart).split("-").map(Number);
    if(!y || !m) return "—";
    return `${y}年${m}月現在`;
  }

  const STORAGE_KEY = "hb_monthly_report_state_v3";

  const DEFAULT_STATE = (() => {
    const now = new Date();
    const cur = monthStartEnd(now.getFullYear(), now.getMonth()+1);
    return {
      meta: { periodStart: cur.start, periodEnd: cur.end },
      counts: { partnerCompanies: 0, targetCompanies: 0 },
      perf: { totalVisit: 0, totalContract: 0, corpVisit: 0, corpContract: 0, referralCards: 0 },
      lastYear: { totalVisit: 0, totalContract: 0, corpVisit: 0, corpContract: 0, referralCards: 0 },
      nextMonthPast: { totalVisit: 0, totalContract: 0, corpVisit: 0, corpContract: 0, referralCards: 0 },
      nextTarget: { totalVisit: 0, totalContract: 0, corpVisit: 0, corpContract: 0, referralCards: 0 },
      partners: [{ name: "", property: "", visit: 0, contract: 0, first: 0, apply: 0 }],
      reportPartners: [{ name: "", property: "", visit: 0, contract: 0, first: 0, apply: 0 }],
      reportPartnersYM: cur.start.slice(0,7),
      topics: ""
    };
  })();

  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return clone(DEFAULT_STATE);
    try{
      const parsed = JSON.parse(raw);
      const s = clone(DEFAULT_STATE);
      const out = {
        ...s,
        ...parsed,
        meta: { ...s.meta, ...(parsed.meta||{}) },
        counts: { ...s.counts, ...(parsed.counts||{}) },
        perf: { ...s.perf, ...(parsed.perf||{}) },
        lastYear: { ...s.lastYear, ...(parsed.lastYear||{}) },
        nextMonthPast: { ...s.nextMonthPast, ...(parsed.nextMonthPast||{}) },
        nextTarget: { ...s.nextTarget, ...(parsed.nextTarget||{}) },
        partners: Array.isArray(parsed.partners) && parsed.partners.length ? parsed.partners : clone(s.partners),
        topics: typeof parsed.topics === "string" ? parsed.topics : ""
      };
      out.partners = out.partners.map(p => ({
        name: p?.name ?? "", property: p?.property ?? "",
        visit: Number(p?.visit ?? 0) || 0, contract: Number(p?.contract ?? 0) || 0,
        first: Number(p?.first ?? 0) || 0, apply: Number(p?.apply ?? 0) || 0
      }));
      return out;
    }catch{ return clone(DEFAULT_STATE); }
  }

  let state = loadState();

  const $ = (id) => document.getElementById(id);
  const nfInt = new Intl.NumberFormat("ja-JP");

  function clamp0(n){ n = Number(n); return Number.isFinite(n) && n>0 ? n : 0; }
  function pct(a,b){ return (b>0) ? (a/b)*100 : 0; }
  function fmt1(n){ return (Number.isFinite(n) ? n : 0).toFixed(1); }

  function setSaveStatus(text){ $("saveStatus").textContent = text; }
  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    setSaveStatus("保存済み");
  }

  function setDelta(elId, now, base){
    const el = $(elId);
    const diff = now - base;
    const sign = diff > 0 ? "+" : "";
    const cls = (Math.abs(diff) < 0.05) ? "neutral" : (diff > 0 ? "good" : "bad");
    el.className = "delta " + cls;
    el.innerHTML = `<span style="font-size:12px;">前年差 ${sign}${fmt1(diff)}pt</span>`;
  }

  const HAS_CHART = (typeof window.Chart !== "undefined");
  let chartKPI, chartFunnel, chartShare, chartPartners;

  const centerLabelPlugin = {
    id: "centerLabel",
    afterDraw(chart){
      if(chart.config.type !== "doughnut") return;
      const {ctx, chartArea} = chart;
      if(!chartArea) return;
      const data = chart.data.datasets?.[0]?.data || [];
      const corp = Number(data[0] || 0);
      const total = data.reduce((a,b)=>a+Number(b||0), 0);
      const p = total ? (corp/total*100) : 0;
      const cx = (chartArea.left + chartArea.right) / 2;
      const cy = (chartArea.top + chartArea.bottom) / 2;
      ctx.save();
      ctx.textAlign = "center"; ctx.textBaseline = "middle";
      ctx.fillStyle = "#0f172a"; ctx.font = "800 24px Montserrat, sans-serif";
      ctx.fillText(p.toFixed(1) + "%", cx, cy - 4);
      ctx.fillStyle = "#64748b"; ctx.font = "700 10px Noto Sans JP, sans-serif";
      ctx.fillText("法人比率", cx, cy + 16);
      ctx.restore();
    }
  };

  function initCharts(){
    if(!HAS_CHART){ console.warn("Chart.js missing."); return; }
    Chart.register(centerLabelPlugin);

    const C = {
      blueBg:"rgba(59,130,246,0.7)", blueBd:"#3b82f6",
      grayBg:"rgba(203,213,225,0.6)", grayBd:"#94a3b8",
      tealBg:"rgba(14,165,233,0.7)", tealBd:"#0ea5e9",
      orgBg: "rgba(249,115,22,0.7)", orgBd: "#f97316",
    };

    chartKPI = new Chart($("chartKPI"), {
      type: "bar",
      data: {
        labels: ["総歩留り","法人来場比","法人契約比","法人歩留り"],
        datasets: [
          { label: "当月", data: [0,0,0,0], backgroundColor:C.blueBg, borderColor:C.blueBd, borderWidth:1 },
          { label: "前年", data: [0,0,0,0], backgroundColor:C.grayBg, borderColor:C.grayBd, borderWidth:1 }
        ]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ position:"top", labels:{boxWidth:12} } },
        scales:{ y:{ beginAtZero:true, suggestedMax: 30, ticks:{ callback:(v)=> v + "%" } } }
      }
    });

    chartFunnel = new Chart($("chartFunnel"), {
      type: "bar",
      data: {
        labels: ["来場 → 契約", "法人来場 → 法人契約"],
        datasets: [{ label: "歩留り(%)", data: [0,0], backgroundColor:C.tealBg, borderColor:C.tealBd, borderWidth:1 }]
      },
      options: {
        indexAxis: "y",
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ display:false } },
        scales:{ x:{ beginAtZero:true, suggestedMax: 30, ticks:{ callback:(v)=> v + "%" } } }
      }
    });

    chartShare = new Chart($("chartShare"), {
      type: "doughnut",
      data: {
        labels: ["法人","非法人"],
        datasets: [{
          data: [0,0],
          backgroundColor:[ "#3b82f6", "#e2e8f0" ],
          borderWidth:0,
          cutout:"70%"
        }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
    });

    chartPartners = new Chart($("chartPartners"), {
      type: "bar",
      data: {
        labels: [],
        datasets: [
          { label:"来場", data: [], backgroundColor:"#3b82f6" },
          { label:"契約", data: [], backgroundColor:"#ef4444" },
          { label:"初回", data: [], backgroundColor:"#10b981" },
          { label:"申込", data: [], backgroundColor:"#f59e0b" }
        ]
      },
      options: {
        indexAxis: "y",
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ position:"top", labels:{boxWidth:10} } },
        scales:{ x:{ beginAtZero:true, ticks:{ precision:0 } } }
      }
    });

    window.addEventListener("beforeprint", ()=>{
      [chartKPI, chartFunnel, chartShare, chartPartners].forEach(c=>{
        try{ c && c.resize(); c && c.update(); }catch(e){}
      });
    });
  }

  function updateCharts(){
    if(!HAS_CHART || !chartKPI) return;
    const c = state.perf;
    const ly = state.lastYear;
    const k_ty = pct(c.totalContract, c.totalVisit);
    const k_cvr= pct(c.corpVisit, c.totalVisit);
    const k_ccr= pct(c.corpContract, c.totalContract);
    const k_cy = pct(c.corpContract, c.corpVisit);
    const ly_ty= pct(ly.totalContract, ly.totalVisit);
    const ly_cvr= pct(ly.corpVisit, ly.totalVisit);
    const ly_ccr= pct(ly.corpContract, ly.totalContract);
    const ly_cy= pct(ly.corpContract, ly.corpVisit);

    chartKPI.data.datasets[0].data = [Number(fmt1(k_ty)), Number(fmt1(k_cvr)), Number(fmt1(k_ccr)), Number(fmt1(k_cy))];
    chartKPI.data.datasets[1].data = [Number(fmt1(ly_ty)), Number(fmt1(ly_cvr)), Number(fmt1(ly_ccr)), Number(fmt1(ly_cy))];
    chartKPI.update();

    chartFunnel.data.datasets[0].data = [Number(fmt1(k_ty)), Number(fmt1(k_cy))];
    chartFunnel.update();

    const nonCorp = Math.max(0, clamp0(c.totalVisit) - clamp0(c.corpVisit));
    chartShare.data.datasets[0].data = [clamp0(c.corpVisit), nonCorp];
    chartShare.update();

    const rows = (state.reportPartners || [])
      .map(p=>({
        name: (p.name || "（未入力）").trim(),
        visit: clamp0(p.visit), contract: clamp0(p.contract),
        first: clamp0(p.first), apply: clamp0(p.apply)
      }))
      .filter(x => x.visit>0 || x.contract>0 || x.first>0 || x.apply>0);
    rows.sort((a,b)=> (b.visit+b.contract+b.first+b.apply) - (a.visit+a.contract+a.first+a.apply));
    const top = rows.slice(0, 8);

    chartPartners.data.labels = top.map(x=>x.name);
    chartPartners.data.datasets[0].data = top.map(x=>x.visit);
    chartPartners.data.datasets[1].data = top.map(x=>x.contract);
    chartPartners.data.datasets[2].data = top.map(x=>x.first);
    chartPartners.data.datasets[3].data = top.map(x=>x.apply);
    chartPartners.update();
  }

  function recalcPeriodsUI(){
    const curStart = state.meta.periodStart;
    const curEnd = state.meta.periodEnd;
    const period = derivePeriodLabelFromStart(curStart);
    $("periodLabel").textContent = period;
    $("lblCurMonth").textContent = period;
    $("lblRangeCur").textContent = `${fmtJP(curStart)} – ${fmtJP(curEnd)}`;
    $("lblPeriodCur").textContent = `${fmtJP(curStart)} – ${fmtJP(curEnd)}`;
    const [yStr, mStr] = String(curStart || "").split("-");
    const year = Number(yStr);
    const month = Number(mStr);
    if(year && month){
      const lyRange = monthStartEnd(year - 1, month);
      $("lblPeriodLY").textContent = `${fmtJP(lyRange.start)} – ${fmtJP(lyRange.end)}`;
      const next = addMonths(year, month, 1);
      const nextRange = monthStartEnd(next.year, next.month);
      $("lblPeriodNextTarget").textContent = `${next.year}.${pad2(next.month)}（${fmtJP(nextRange.start)} – ${fmtJP(nextRange.end)}）`;
      const nextPast = monthStartEnd(next.year - 1, next.month);
      $("lblPeriodNextPast").textContent = `${(next.year-1)}.${pad2(next.month)}（${fmtJP(nextPast.start)} – ${fmtJP(nextPast.end)}）`;
    }else{
      $("lblPeriodLY").textContent = "-"; $("lblPeriodNextTarget").textContent = "-"; $("lblPeriodNextPast").textContent = "-";
    }
    $("badgeCoverage").textContent = monthNowLabel(curStart);
  }

  function trashSvg(){
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><path d="M3 6h18"></path><path d="M8 6V4h8v2"></path><path d="M19 6l-1 14H6L5 6"></path></svg>`;
  }

  function renderPartners(){
    const tbody = $("partnersBody");
    tbody.innerHTML = "";
    (state.reportPartners || []).forEach((p, idx)=>{
      const tr = document.createElement("tr");
      const tdName = document.createElement("td");
      const iName = document.createElement("input");
      iName.value = p.name || ""; iName.placeholder = "例：ベルス";
      iName.addEventListener("input", ()=>{ p.name = iName.value; setSaveStatus("編集中…"); recalcAll(); saveState(); });
      tdName.appendChild(iName);
      
      const tdProp = document.createElement("td");
      const iProp = document.createElement("input");
      iProp.value = p.property || ""; iProp.placeholder = "例：LP浦和神明";
      iProp.addEventListener("input", ()=>{ p.property = iProp.value; setSaveStatus("編集中…"); recalcAll(); saveState(); });
      tdProp.appendChild(iProp);

      const mkNum = (k)=>{
        const td = document.createElement("td"); td.className="center";
        const inp = document.createElement("input");
        inp.type = "number"; inp.min="0"; inp.value = clamp0(p[k]);
        inp.addEventListener("input", ()=>{ p[k]=clamp0(inp.value); setSaveStatus("編集中…"); recalcAll(); saveState(); });
        td.appendChild(inp); return td;
      };

      const tdDel = document.createElement("td"); tdDel.className = "center";
      const b = document.createElement("button"); b.className = "icon-btn"; b.type = "button";
      b.innerHTML = trashSvg();
      b.addEventListener("click", ()=>{
        state.reportPartners.splice(idx, 1);
        if(state.reportPartners.length===0) state.reportPartners.push({name:"",property:"",visit:0,contract:0,first:0,apply:0});
        renderPartners(); recalcAll(); saveState();
      });
      tdDel.appendChild(b);

      tr.appendChild(tdName); tr.appendChild(tdProp);
      tr.appendChild(mkNum("visit")); tr.appendChild(mkNum("contract"));
      tr.appendChild(mkNum("first")); tr.appendChild(mkNum("apply"));
      tr.appendChild(tdDel);
      tbody.appendChild(tr);
    });
  }

  function setUIFromState(){
    $("periodStart").value = state.meta.periodStart || "";
    $("periodEnd").value = state.meta.periodEnd || "";
    $("companyCount").value = clamp0(state.counts.partnerCompanies);
    $("targetCount").value = clamp0(state.counts.targetCompanies);
    
    const setv = (id, v) => $(id).value = clamp0(v);
    const c = state.perf;
    setv("v_totalVisit",c.totalVisit); setv("v_totalContract",c.totalContract);
    setv("v_corpVisit",c.corpVisit); setv("v_corpContract",c.corpContract); setv("v_referralCards",c.referralCards);
    
    const ly = state.lastYear;
    setv("ly_totalVisit",ly.totalVisit); setv("ly_totalContract",ly.totalContract);
    setv("ly_corpVisit",ly.corpVisit); setv("ly_corpContract",ly.corpContract); setv("ly_referralCards",ly.referralCards);
    
    const nm = state.nextMonthPast;
    setv("nm_totalVisit",nm.totalVisit); setv("nm_totalContract",nm.totalContract);
    setv("nm_corpVisit",nm.corpVisit); setv("nm_corpContract",nm.corpContract); setv("nm_referralCards",nm.referralCards);
    
    const tg = state.nextTarget;
    setv("tg_totalVisit",tg.totalVisit); setv("tg_totalContract",tg.totalContract);
    setv("tg_corpVisit",tg.corpVisit); setv("tg_corpContract",tg.corpContract); setv("tg_referralCards",tg.referralCards);
    
    $("topics").value = state.topics || "";
    recalcPeriodsUI();
  }

  function readInputsToState(){
    state.meta.periodStart = $("periodStart").value;
    state.meta.periodEnd = $("periodEnd").value;
    state.reportPartnersYM = String(state.meta.periodStart||"").slice(0,7);
    state.counts.partnerCompanies = clamp0($("companyCount").value);
    state.counts.targetCompanies = clamp0($("targetCount").value);
    
    const getv = (id) => clamp0($(id).value);
    const c = state.perf;
    c.totalVisit=getv("v_totalVisit"); c.totalContract=getv("v_totalContract");
    c.corpVisit=getv("v_corpVisit"); c.corpContract=getv("v_corpContract"); c.referralCards=getv("v_referralCards");
    
    const ly = state.lastYear;
    ly.totalVisit=getv("ly_totalVisit"); ly.totalContract=getv("ly_totalContract");
    ly.corpVisit=getv("ly_corpVisit"); ly.corpContract=getv("ly_corpContract"); ly.referralCards=getv("ly_referralCards");
    
    const nm = state.nextMonthPast;
    nm.totalVisit=getv("nm_totalVisit"); nm.totalContract=getv("nm_totalContract");
    nm.corpVisit=getv("nm_corpVisit"); nm.corpContract=getv("nm_corpContract"); nm.referralCards=getv("nm_referralCards");
    
    const tg = state.nextTarget;
    tg.totalVisit=getv("tg_totalVisit"); tg.totalContract=getv("tg_totalContract");
    tg.corpVisit=getv("tg_corpVisit"); tg.corpContract=getv("tg_corpContract"); tg.referralCards=getv("tg_referralCards");
    
    state.topics = $("topics").value;
  }

  function recalcAll(){
    const c = state.perf;
    const ly = state.lastYear;
    const k_ty = pct(c.totalContract, c.totalVisit);
    const k_cvr= pct(c.corpVisit, c.totalVisit);
    const k_ccr= pct(c.corpContract, c.totalContract);
    const k_cy = pct(c.corpContract, c.corpVisit);
    $("k_ty").textContent = fmt1(k_ty); $("k_cvr").textContent = fmt1(k_cvr);
    $("k_ccr").textContent = fmt1(k_ccr); $("k_cy").textContent = fmt1(k_cy);

    const ly_ty= pct(ly.totalContract, ly.totalVisit);
    const ly_cvr= pct(ly.corpVisit, ly.totalVisit);
    const ly_ccr= pct(ly.corpContract, ly.totalContract);
    const ly_cy= pct(ly.corpContract, ly.corpVisit);
    setDelta("d_ty",k_ty,ly_ty); setDelta("d_cvr",k_cvr,ly_cvr);
    setDelta("d_ccr",k_ccr,ly_ccr); setDelta("d_cy",k_cy,ly_cy);

    const sumV = (state.reportPartners||[]).reduce((s,p)=> s + clamp0(p.visit), 0);
    const sumC = (state.reportPartners||[]).reduce((s,p)=> s + clamp0(p.contract), 0);
    const sumF = (state.reportPartners||[]).reduce((s,p)=> s + clamp0(p.first), 0);
    const sumA = (state.reportPartners||[]).reduce((s,p)=> s + clamp0(p.apply), 0);
    
    // フッターの合計値を更新
    $("t_visit").textContent = nfInt.format(sumV);
    $("t_contract").textContent = nfInt.format(sumC);
    $("t_first").textContent = nfInt.format(sumF);
    $("t_apply").textContent = nfInt.format(sumA);

    const nm = state.nextMonthPast;
    const nm_cvr = pct(nm.corpVisit, nm.totalVisit);
    const nm_cy  = pct(nm.corpContract, nm.corpVisit);
    $("nm_k_cvr").textContent = `${fmt1(nm_cvr)}%`; $("nm_k_cy").textContent = `${fmt1(nm_cy)}%`;
    
    const tg = state.nextTarget;
    const tg_cvr = pct(tg.corpVisit, tg.totalVisit);
    const tg_cy  = pct(tg.corpContract, tg.corpVisit);
    $("tg_k_cvr").textContent = `${fmt1(tg_cvr)}%`; $("tg_k_cy").textContent = `${fmt1(tg_cy)}%`;
    
    updateCharts();
  }

  function exportJSON(){
    const period = derivePeriodLabelFromStart(state.meta.periodStart).replace(".","-");
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `hb_monthly_report_${period || "data"}.json`;
    a.click(); URL.revokeObjectURL(url);
  }

  function importJSON(){
    const inp = document.createElement("input");
    inp.type = "file"; inp.accept = "application/json";
    inp.onchange = async () => {
      const file = inp.files?.[0]; if(!file) return;
      try{
        const text = await file.text();
        const obj = JSON.parse(text);
        const s = clone(DEFAULT_STATE);
        state = {
          ...s, ...obj,
          meta: { ...s.meta, ...(obj.meta||{}) },
          counts: { ...s.counts, ...(obj.counts||{}) },
          perf: { ...s.perf, ...(obj.perf||{}) },
          lastYear: { ...s.lastYear, ...(obj.lastYear||{}) },
          nextMonthPast: { ...s.nextMonthPast, ...(obj.nextMonthPast||{}) },
          nextTarget: { ...s.nextTarget, ...(obj.nextTarget||{}) },
          partners: Array.isArray(obj.partners) ? obj.partners : clone(s.partners),
          reportPartners: Array.isArray(obj.reportPartners) ? obj.reportPartners : clone(s.reportPartners),
          reportPartnersYM: obj.reportPartnersYM || s.reportPartnersYM,
          topics: obj.topics || ""
        };
        state.reportPartners = state.reportPartners.map(p => ({
          name: p?.name ?? "", property: p?.property ?? "",
          visit: Number(p?.visit ?? 0) || 0, contract: Number(p?.contract ?? 0) || 0,
          first: Number(p?.first ?? 0) || 0, apply: Number(p?.apply ?? 0) || 0
        }));
        setUIFromState(); renderPartners(); recalcAll(); saveState();
      }catch(e){ alert("JSON読込失敗: "+e); }
    };
    inp.click();
  }

  function resetAll(){
    if(!confirm("全てのデータを初期化しますか？")) return;
    state = clone(DEFAULT_STATE);
    localStorage.removeItem(STORAGE_KEY);
    setUIFromState(); renderPartners(); recalcAll(); saveState();
  }

  function attachEventsOnce(){
    const onAnyInput = () => {
      setSaveStatus("編集中…");
      readInputsToState(); recalcPeriodsUI(); recalcAll(); saveState();
    };
    [
      "periodStart","periodEnd","companyCount","targetCount",
      "v_totalVisit","v_totalContract","v_corpVisit","v_corpContract","v_referralCards",
      "ly_totalVisit","ly_totalContract","ly_corpVisit","ly_corpContract","ly_referralCards",
      "nm_totalVisit","nm_totalContract","nm_corpVisit","nm_corpContract","nm_referralCards",
      "tg_totalVisit","tg_totalContract","tg_corpVisit","tg_corpContract","tg_referralCards",
      "topics"
    ].forEach(id => { const el=$(id); if(el) el.addEventListener("input", onAnyInput); });

    $("btnAddRow").addEventListener("click", ()=>{
      state.reportPartners.push({ name:"", property:"", visit:0, contract:0, first:0, apply:0 });
      renderPartners(); recalcAll(); saveState();
    });
    $("btnExport").addEventListener("click", exportJSON);
    $("btnImport").addEventListener("click", importJSON);
    $("btnReset").addEventListener("click", resetAll);
    $("btnPrint").addEventListener("click", ()=>{
      const w = window.open("./print.html", "_blank"); if(w) w.opener = null;
    });
  }

  initCharts();
  setUIFromState();
  renderPartners();
  recalcAll();
  attachEventsOnce();
  setSaveStatus("保存済み");
  
  fetch('./datalatest.json?v=' + new Date().getTime())
    .then(r => r.ok ? r.json() : null)
    .then(obj => {
      if(!obj) return;
      const s = clone(DEFAULT_STATE);
      state = {
        ...s, ...obj,
        meta: { ...s.meta, ...(obj.meta||{}) },
        counts: { ...s.counts, ...(obj.counts||{}) },
        perf: { ...s.perf, ...(obj.perf||{}) },
        lastYear: { ...s.lastYear, ...(obj.lastYear||{}) },
        nextMonthPast: { ...s.nextMonthPast, ...(obj.nextMonthPast||{}) },
        nextTarget: { ...s.nextTarget, ...(obj.nextTarget||{}) },
        partners: Array.isArray(obj.partners) ? obj.partners : clone(s.partners),
        reportPartners: Array.isArray(obj.reportPartners) ? obj.reportPartners : clone(s.reportPartners),
        reportPartnersYM: obj.reportPartnersYM || s.reportPartnersYM,
        topics: obj.topics || ""
      };
      setUIFromState(); renderPartners(); recalcAll(); saveState();
      setSaveStatus("データ読込完了");
    })
    .catch(e => console.log("読込スキップ:", e));

})();
</script>
</body>
</html>